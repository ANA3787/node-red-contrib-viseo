<script type="text/javascript">

    var saveButtons = function(buttons, $query){
        $query.each(function(){
            buttons.push({
                title :  $(this).find('.node-input-title').val(),
                action : $(this).find('.node-input-action').val(),
                value :  $(this).find('.node-input-value').val(),
            })
        })
    }
    var readButtons = function(buttons, $query){
        var $tmpl = $query.last().clone();
        $query.remove();
        for (var i = 0 ; i < buttons.length; i++){
            var $clone = $tmpl.clone();
            //$addquick.before($clone);
            $clone.find('.node-input-title').val(node.quickreplies[i].title);
            $clone.find('.node-input-action').val(node.quickreplies[i].action);
            $clone.find('.node-input-value').val(node.quickreplies[i].value);
        }
    }

    RED.nodes.registerType('send-card-beta',{
        category: 'VISEO_BOT',
        color: '#3FADB5',
        defaults: {
            name:      { value: undefined },
            prompt:    { value: undefined },
            delay:     { value: 0 },
            sendType: { value: "text" },
            text:      { value: undefined },
            random:    { value: undefined },
            media:     { value: undefined },
            title:     { value: undefined },
            subtitle:  { value: undefined },
            subtext:   { value: undefined },
            attach:    { value: undefined },
            carousel:  { value: undefined },
            bt1lbl:    { value: undefined },
            bt2lbl:    { value: undefined },
            bt3lbl:    { value: undefined },
            bt1action: { value: "postBack" },
            bt2action: { value: "postBack" },
            bt3action: { value: "postBack" },
            bt1value:  { value: undefined },
            bt2value:  { value: undefined },
            bt3value:  { value: undefined },
            quicktext: { value: undefined },
            quickreplies: { value: null }
        },
        inputs:1,
        outputs:1,
        oneditprepare: function () {
            $('#node-input-sendType').change(function (event) { 
                var type = $(this).val();
                $('#send-type').find('section').each(function () {
                    if ($(this).attr('id').indexOf(type) >= 0) {
                        $(this).addClass('visible');
                    } else {
                        $(this).removeClass('visible');
                    }
                });
            });

            // Add Button
            var $addquick = $('#addquick');
            $addquick.on('click', function(){
                var $quicktmpl = $('#quick-type .quickbt').last();
                $quicktmpl.before($quicktmpl.clone());
            })

            // Fill previous quick replies
            var node = this;
            node.quickreplies = node.quickreplies || [];

            var $quicktmpl = $('#quick-type .quickbt').last().clone();
            $('#quick-type .quickbt').remove();
            for (var i = 0 ; i < node.quickreplies.length; i++){
                var $clone = $quicktmpl.clone();
                $addquick.before($clone);
                $clone.find('.node-input-title').val(node.quickreplies[i].title);
                $clone.find('.node-input-action').val(node.quickreplies[i].action);
                $clone.find('.node-input-value').val(node.quickreplies[i].value);
            }
        },
        oneditsave: function(){
            var node = this;
            node.quickreplies = [];
            saveButtons(node.quickreplies, $('#quick-type .quickbt'))
        },
        icon: function() {
            if (this.sendType === "text") { return "text.svg"; } 
            if (this.sendType === "media") { return "picture.svg"; } 
            if (this.sendType === "quick") { return "buttons.svg"; }
            if (this.sendType === "card") { return "card.svg"; }
        }, 
        align: "left",
        paletteLabel: "Message",
        labelStyle: "bot-card-name",
        label: function() { return (this.name || this.text || "Send Card") }
    });
</script>

<style>
    #send-type > section  { display: none; }
    #send-type > .visible { display: block; }
</style>

<script type="text/x-red" data-template-name="send-card">

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-prompt"><i class="icon-tag"></i> Prompt</label>
        <input type="checkbox" style="width: auto;" id="node-input-prompt"> <span style="font-size: 12px">(require user inputs)</span>
    </div>
    <div class="form-row">
        <label for="node-input-delay"><i class="icon-tag"></i> Delay</label>
        <input type="text" id="node-input-delay" placeholder="0">
    </div>
    <h5 style="border-bottom: 1px solid #AAA; margin: 1em 0em 1em 0em;">Send format</h5>

    <div class="form-row">
        <label for="node-input-sendType"><i class="icon-tag"></i> Type</label>
        <select id="node-input-sendType">
            <option value="text">Text</option>
            <option value="media">Image</option>
            <option value="card">Card</option>
            <option value="quick">Quick replies</option>
        </select>
    </div>

    <div id="send-type">
        <section id="text-type" class="visible">
            <div id="msg-text" class="msg-tabs-panel">
                <h4 style="border-bottom: 1px solid #AAA; margin: 1em 0em 1em 0em;">Text Message</h4>
                <div class="form-row">
                    <label for="node-input-text"><i class="icon-tag"></i> Text</label>
                    <textarea id="node-input-text" rows="5" style="width:300px"></textarea>
                </div>
                <div class="form-row">
                    <label for="node-input-random"><i class="icon-tag"></i> Random</label>
                    <input type="checkbox" style="width: auto;" id="node-input-random"> <span style="font-size: 12px">(on each line of text)</span>
                </div>
            </div>
        </section>
        <section id="media-type">
            <div id="msg-media" class="msg-tabs-panel">
                <h4 style="border-bottom: 1px solid #AAA; margin: 1em 0em 1em 0em;">Media Message</h4>
                <div class="form-row">
                    <label for="node-input-media"><i class="icon-tag"></i> Media</label>
                    <input type="text" id="node-input-media" placeholder="http://path/to/card/image">
                </div>
            </div>
        </section>
        <section id="card-type">
            <div id="msg-card" class="msg-tabs-panel">
                <h4 style="border-bottom: 1px solid #AAA; margin: 1em 0em 1em 0em;">Hero Card</h4>
                <div class="form-row">
                    <label for="node-input-title"><i class="icon-tag"></i> Title</label>
                    <input type="text" id="node-input-title" placeholder="Card title">
                </div>
                <div class="form-row">
                    <label for="node-input-subtitle"><i class="icon-tag"></i> Subtitle</label>
                    <textarea id="node-input-subtitle" rows="3" style="width:300px"></textarea>
                </div>
                <div class="form-row">
                    <label for="node-input-subtext"><i class="icon-tag"></i> Text</label>
                    <textarea id="node-input-subtext" rows="3" style="width:300px"></textarea>
                    <div style="padding-left: 104px;"><i class="fa fa-exclamation-triangle"></i> <em>Won't work with Facebook Messenger</em></div>
                </div>
                <div class="form-row">
                    <label for="node-input-attach"><i class="icon-tag"></i> Attachement</label>
                    <input type="text" id="node-input-attach" placeholder="http://path/to/card/image">
                </div>
                <div class="form-row">
                    <label for="node-input-bt1lbl"><i class="icon-tag"></i> Button 1</label>
                    <input  style="width: 20%" id="node-input-bt1lbl" type="text" placeholder="Label">
                    <select style="width: 20%" id="node-input-bt1action">
                        <option value="postBack">Post Back</option>
                        <option value="imBack">IM Back</option>
                        <option value="openUrl">Open URL</option>
                        <option value="showImage">Show Image</option>
                        <option value="playAudio">Play Audio</option>
                        <option value="playVideo">Play Video</option>
                        <option value="call">Call</option>
                    </select>
                    <input  style="width: 20%" id="node-input-bt1value" type="text" placeholder="Value">
                </div>
                <div class="form-row">
                    <label for="node-input-bt2lbl"><i class="icon-tag"></i> Button 2</label>
                    <input  style="width: 20%" id="node-input-bt2lbl" type="text" placeholder="Label">
                    <select style="width: 20%" id="node-input-bt2action">
                        <option value="postBack">Post Back</option>
                        <option value="imBack">IM Back</option>
                        <option value="openUrl">Open URL</option>
                        <option value="showImage">Show Image</option>
                        <option value="playAudio">Play Audio</option>
                        <option value="playVideo">Play Video</option>
                        <option value="call">Call</option>
                    </select>
                    <input  style="width: 20%" id="node-input-bt2value" type="text" placeholder="Value">
                </div>
                <div class="form-row">
                    <label for="node-input-bt3lbl"><i class="icon-tag"></i> Button 3</label>
                    <input  style="width: 20%" id="node-input-bt3lbl" type="text" placeholder="Label">
                    <select style="width: 20%" id="node-input-bt3action">
                        <option value="postBack">Post Back</option>
                        <option value="imBack">IM Back</option>
                        <option value="openUrl">Open URL</option>
                        <option value="showImage">Show Image</option>
                        <option value="playAudio">Play Audio</option>
                        <option value="playVideo">Play Video</option>
                        <option value="call">Call</option>
                    </select>
                    <input  style="width: 20%" id="node-input-bt3value" type="text" placeholder="Value">
                </div>
                <div class="form-row">
                    <label for="node-input-carousel"><i class="icon-tag"></i> Carousel</label>
                    <input type="checkbox" style="width: auto;" id="node-input-carousel"> <span style="font-size: 12px">(add to next card)</span>
                </div>
            </div>
        </section>
        <section id="quick-type">
            <h4 style="border-bottom: 1px solid #AAA; margin: 1em 0em 1em 0em;">Facebook's quick replies</h4>
            <div class="form-row">
                <label for="node-input-quicktext"><i class="icon-tag"></i> Text</label>
                <textarea id="node-input-quicktext" rows="5" style="width:300px"></textarea>
            </div>

            <div class="form-row quickbt">
                <label><i class="icon-tag"></i> Button</label>
                <input  style="width: 20%" class="node-input-title"  type="text" placeholder="Label">
                <select style="width: 20%" class="node-input-action">
                    <option value="postBack">Post Back</option>
                    <option value="imBack">IM Back</option>
                    <option value="openUrl">Open URL</option>
                    <option value="showImage">Show Image</option>
                    <option value="playAudio">Play Audio</option>
                    <option value="playVideo">Play Video</option>
                    <option value="call">Call</option>
                </select>
                <input  style="width: 20%" class="node-input-value" type="text" placeholder="Value">
            </div>
            <button id="addquick">Add</button>
        </section>
    </div>

</script>

<script type="text/x-red" data-help-name="send-card">

</script>
