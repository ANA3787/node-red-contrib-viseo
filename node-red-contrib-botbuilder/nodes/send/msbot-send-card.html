<script type="text/javascript">
    RED.nodes.registerType('send-card',{
        category: 'VISEO_BOT',
        color: '#3FADB5',
        defaults: { 
            name:      { value: undefined },
            prompt:    { value: undefined },
            delay:     { value: 0 },
            text:      { value: undefined },
            random:    { value: undefined },
            media:     { value: undefined },
            title:     { value: undefined },
            subtitle:  { value: undefined },
            subtext:   { value: undefined },
            attach:    { value: undefined },
            carousel:  { value: undefined },
            bt1lbl:    { value: undefined },
            bt2lbl:    { value: undefined },
            bt3lbl:    { value: undefined },
            bt1action: { value: "postBack" },
            bt2action: { value: "postBack" },
            bt3action: { value: "postBack" },
            bt1value:  { value: undefined },
            bt2value:  { value: undefined },
            bt3value:  { value: undefined },
        },
        inputs:1,
        outputs:1,
        icon: function() {
            if (this.text) { return "text.svg"; } 

            var feat = 0;
            var icon = "";
            if (this.attach) { feat++;  icon = "picture.svg"; } 
            if (this.buttons){ feat++;  icon = "buttons.svg"; }
            if (this.title || this.subtitle){ feat++;  icon = "text.svg"; }
            if (feat != 1) { icon = "card.svg"; }
            
            return icon; 
        }, 
        align: "left",
        paletteLabel: "Message",
        labelStyle: "bot-card-name",
        label: function() { return (this.name || this.text || "Send Card") }
    });
</script>

<script type="text/javascript">

    jQuery.fn.exists = function(){return this.length>0;}

    $(document).ready(function() {
        setTimeout(function(){

            // Add repaint button on tabs
            var $btn = $('<button class="bot-repaint"><i class="fa fa-comment"></i></button>');
            $btn.on('click', repaintAll);
            $('#workspace').append($btn);

            // Bind click on 
            $(document).on('click', '.msg-tabs A.red-ui-tab-label', function(e){
                var $elm  = $(e.target).closest('A');
                
                $('.msg-tabs .red-ui-tab').removeClass('active');
                $elm.parents('.red-ui-tab').addClass('active');

                $('.msg-tabs-panel').hide();
                $($elm.attr('href')).show();
            });

        },1)
    })

var repaintAll = function(){
    $(document).find('.bot-card-name').each(function(idx, elm){
        repaint($(elm).closest('.nodegroup'));
    })
}

var repaint = function($node){
    
    var nodeId     = $node.attr('id');
    var nodeRED    = RED.nodes.node(nodeId);
    var nodeD3     = d3.select($node[0]);

    var cardWidth  = 250;
    var cardHeight = 6;
    var imgHeight  = 100;
    var lineHeight = 18;
    var msgType    = "bot-msg";

    // Build HTML
    var html = '';
    if (nodeRED.text){
        cardHeight += lineHeight * Math.round(nodeRED.text.length / 50);
        html += '<div class="bot-msg-text">' + nodeRED.text + '</div>'
    }
    if (nodeRED.attach){
        cardHeight += imgHeight;
        html += '<div class="bot-msg-img" style="background-image: url(\''+nodeRED.attach+'\');"></div>'
    }

    if (nodeRED.title){
        cardHeight += lineHeight;
        html += '<div class="bot-msg-title">' + nodeRED.title + '</div>';
        msgType = "bot-card";
    }

    if (nodeRED.subtitle){
        cardHeight += lineHeight*2;
        html += '<div class="bot-msg-subtitle">' + nodeRED.subtitle + '</div>'
        msgType = "bot-card";
    }

    var tmp = ''; var count = 0;
    if (nodeRED.bt1lbl){ tmp += '<li>' + nodeRED.bt1lbl + '</li>'; count++; }
    if (nodeRED.bt2lbl){ tmp += '<li>' + nodeRED.bt2lbl + '</li>'; count++; }
    if (nodeRED.bt3lbl){ tmp += '<li>' + nodeRED.bt3lbl + '</li>'; count++; }
    if (tmp) { html += '<ul class="bot-msg-btn bot-msg-btn-'+count+'">'+tmp+'</ul>' }
    cardHeight += count > 2 ? lineHeight*count : lineHeight;

    // Insert HTML Shim
    var shim = $node.find('.bot-shim');
    if (!shim.exists()){ 
        // First Repaint
        shim = nodeD3.insert("foreignObject",":first-child")
                     .attr('class', 'bot-shim')
                     .attr('x', 0).attr('y', 0)
                     .attr('width',  cardWidth);

        // Hide nodes
        $node.find('.bot-card-name').first().hide();
        $node.find('.node_icon_group').first().hide();

        // Trap events
        var $anchor = $node.find('.node').first();
            $anchor.attr("fill-opacity","0")
                   .attr("rx","10").attr("ry","10")
                   .on("mousedown",  function(){ repaint($node) })
                   .on("mouseup",    function(){ repaint($node) })
                   .on("touchstart", function(){ repaint($node) })
                   .on("touchend",   function(){ repaint($node) })
    }

    // Repaint HTML
    cardHeight = Math.max(cardHeight, 40);
    shim.html('<div class="'+msgType+'" style="height:'+(cardHeight-2)+'px;">'+html+'</div>').attr('height', cardHeight)

    // Resize
    $node.find('.node').first().attr("width", cardWidth).attr("height", cardHeight);
    
    // Outputs
    $node.find('.port_output').each(function(){
        var $this = $(this);
        var tY =  /translate\(\d+,(\d+)\)/.exec($this.attr("transform"))[1];
        $this.attr("transform", "translate("+( cardWidth-5 )+","+( tY )+")")
    });
}
</script>

<style>
    .bot-msg { 
        border: 1px solid #AAAAAA; border-radius: 10px; 
        background-color: #CCCCCC; 
        line-height: 12px;
    }
    .bot-card { 
        border: 1px solid #AAAAAA; border-radius: 10px; 
        background-color: white; 
        line-height: 12px; 
    }
    .bot-msg  .bot-msg-img,
    .bot-card .bot-msg-img {
        width:  250px; 
        height: 100px;
        background-position: center;
        background-size: 250px auto;
        border-radius: 10px 10px 0 0;
        overflow: hidden;
    }
    .bot-msg  .bot-msg-img      { border-radius: 10px; }
    .bot-msg  .bot-msg-text     { padding: 2px 6px 2px 6px; font-size: 12px; color: #222222; }
    .bot-card .bot-msg-title    { padding: 4px 5px 0px 5px; font-size: 11px; font-weight: bold; }
    .bot-card .bot-msg-subtitle { padding: 4px 5px 0px 5px; font-size: 10px; color: #999999; min-height: 40px; }
    
    .bot-card .bot-msg-btn-1,     .bot-card .bot-msg-btn-2     { margin: 4px 0 0 0; text-align: right; color: #0083fe }
    .bot-card .bot-msg-btn-1 LI,  .bot-card .bot-msg-btn-2  LI { display: inline; list-style: none;  font-size: 12px; margin-right: 6px; }

    .bot-repaint { position: absolute; top: 3px; right: 38px; width: 32px; height: 32px; }
</style>


<script type="text/x-red" data-template-name="send-card">

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-prompt"><i class="icon-tag"></i> Prompt</label>
        <input type="checkbox" style="width: auto;" id="node-input-prompt"> <span style="font-size: 12px">(require user inputs)</span>
    </div>
    <div class="form-row">
        <label for="node-input-delay"><i class="icon-tag"></i> Delay</label>
        <input type="text" id="node-input-delay" placeholder="0">
    </div>

    <div class="red-ui-tabs">
        <ul class="msg-tabs">
        <li class="red-ui-tab active"><a href="#msg-text" class="red-ui-tab-label"><span>Text</span></a></li>
        <li class="red-ui-tab"><a href="#msg-media" class="red-ui-tab-label"><span>Media</span></a></li>
        <li class="red-ui-tab"><a href="#msg-card" class="red-ui-tab-label"><span>Cards</span></a></li>
        </ul>
    </div>

    <div id="msg-text" class="msg-tabs-panel">
        <h4 style="border-bottom: 1px solid #AAA; margin: 1em 0em 1em 0em;">Text Message</h4>
        <div class="form-row">
            <label for="node-input-text"><i class="icon-tag"></i> Text</label>
            <textarea id="node-input-text" rows="5" style="width:300px"></textarea>
        </div>
        <div class="form-row">
            <label for="node-input-random"><i class="icon-tag"></i> Random</label>
            <input type="checkbox" style="width: auto;" id="node-input-random"> <span style="font-size: 12px">(on each line of text)</span>
        </div>
    </div>

    <div id="msg-media" class="msg-tabs-panel" style="display:none">
        <h4 style="border-bottom: 1px solid #AAA; margin: 1em 0em 1em 0em;">Media Message</h4>
        <div class="form-row">
            <label for="node-input-media"><i class="icon-tag"></i> Media</label>
            <input type="text" id="node-input-media" placeholder="http://path/to/card/image">
        </div>
    </div>

    <div id="msg-card" class="msg-tabs-panel" style="display:none">
        <h4 style="border-bottom: 1px solid #AAA; margin: 1em 0em 1em 0em;">Hero Card</h4>
        <div class="form-row">
            <label for="node-input-title"><i class="icon-tag"></i> Title</label>
            <input type="text" id="node-input-title" placeholder="Card title">
        </div>
        <div class="form-row">
            <label for="node-input-subtitle"><i class="icon-tag"></i> Subtitle</label>
            <textarea id="node-input-subtitle" rows="3" style="width:300px"></textarea>
        </div>
        <div class="form-row">
            <label for="node-input-subtext"><i class="icon-tag"></i> Text</label>
            <textarea id="node-input-subtext" rows="3" style="width:300px"></textarea>
            <div style="padding-left: 104px;"><i class="fa fa-exclamation-triangle"></i> <em>Won't work with Facebook Messenger</em></div>
        </div>
        <div class="form-row">
            <label for="node-input-attach"><i class="icon-tag"></i> Attachement</label>
            <input type="text" id="node-input-attach" placeholder="http://path/to/card/image">
        </div>
        <div class="form-row">
            <label for="node-input-bt1lbl"><i class="icon-tag"></i> Button 1</label>
            <input  style="width: 20%" id="node-input-bt1lbl" type="text" placeholder="Label">
            <select style="width: 20%" id="node-input-bt1action">
                <option value="postBack">Post Back</option>
                <option value="imBack">IM Back</option>
                <option value="openUrl">Open URL</option>
                <option value="showImage">Show Image</option>
                <option value="playAudio">Play Audio</option>
                <option value="playVideo">Play Video</option>
                <option value="call">Call</option>
            </select>
            <input  style="width: 20%" id="node-input-bt1value" type="text" placeholder="Value">
        </div>
        <div class="form-row">
            <label for="node-input-bt2lbl"><i class="icon-tag"></i> Button 2</label>
            <input  style="width: 20%" id="node-input-bt2lbl" type="text" placeholder="Label">
            <select style="width: 20%" id="node-input-bt2action">
                <option value="postBack">Post Back</option>
                <option value="imBack">IM Back</option>
                <option value="openUrl">Open URL</option>
                <option value="showImage">Show Image</option>
                <option value="playAudio">Play Audio</option>
                <option value="playVideo">Play Video</option>
                <option value="call">Call</option>
            </select>
            <input  style="width: 20%" id="node-input-bt2value" type="text" placeholder="Value">
        </div>
        <div class="form-row">
            <label for="node-input-bt3lbl"><i class="icon-tag"></i> Button 3</label>
            <input  style="width: 20%" id="node-input-bt3lbl" type="text" placeholder="Label">
            <select style="width: 20%" id="node-input-bt3action">
                <option value="postBack">Post Back</option>
                <option value="imBack">IM Back</option>
                <option value="openUrl">Open URL</option>
                <option value="showImage">Show Image</option>
                <option value="playAudio">Play Audio</option>
                <option value="playVideo">Play Video</option>
                <option value="call">Call</option>
            </select>
            <input  style="width: 20%" id="node-input-bt3value" type="text" placeholder="Value">
        </div>
        <div class="form-row">
            <label for="node-input-carousel"><i class="icon-tag"></i> Carousel</label>
            <input type="checkbox" style="width: auto;" id="node-input-carousel"> <span style="font-size: 12px">(add to next card)</span>
        </div>
    </div>

</script>

<script type="text/x-red" data-help-name="send-card">

</script>
